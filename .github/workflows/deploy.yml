name: ğŸš€ Deploy to Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run tests
      run: npm test || true
      
    - name: ğŸ—ï¸ Build project
      run: npm run build
      
    - name: ğŸ“ Create deployment package
      run: |
        mkdir -p deploy-package
        cp -r dist/ deploy-package/
        cp -r server.js package*.json deploy-package/
        cp -r scripts/ deploy-package/
        cp -r nginx.conf ecosystem.config.js deploy-package/
        cp -r data/ deploy-package/ || mkdir -p deploy-package/data
        tar -czf deploy-package.tar.gz deploy-package/
        
    - name: ğŸš€ Deploy to server
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          # åœæ­¢ç¾æœ‰æœå‹™
          pm2 stop my-vue-app || true
          
          # å‚™ä»½ç¾æœ‰éƒ¨ç½²
          sudo mkdir -p /var/backups/my-vue-app
          sudo cp -r /var/www/my-vue-app /var/backups/my-vue-app/backup-$(date +%Y%m%d-%H%M%S) || true
          
          # å»ºç«‹éƒ¨ç½²ç›®éŒ„
          sudo mkdir -p /var/www/my-vue-app
          sudo chown $USER:$USER /var/www/my-vue-app
          
          # ä¸‹è¼‰ä¸¦è§£å£“ç¸®éƒ¨ç½²åŒ…
          cd /var/www/my-vue-app
          wget -O deploy-package.tar.gz "${{ secrets.DEPLOY_URL }}/deploy-package.tar.gz"
          tar -xzf deploy-package.tar.gz --strip-components=1
          
          # å®‰è£ç”Ÿç”¢ç’°å¢ƒä¾è³´
          npm install --production
          
          # è¨­å®šç’°å¢ƒè®Šæ•¸
          echo "NODE_ENV=production" > .env
          echo "PORT=3000" >> .env
          
          # å•Ÿå‹•æœå‹™
          pm2 start ecosystem.config.js
          pm2 save
          
          # é‡æ–°è¼‰å…¥ Nginxï¼ˆå¦‚æœéœ€è¦ï¼‰
          sudo nginx -t && sudo systemctl reload nginx || true
          
          # æ¸…ç†
          rm -f deploy-package.tar.gz
          
    - name: ğŸ“¢ Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
        else
          echo "âŒ éƒ¨ç½²å¤±æ•—ï¼"
        fi 